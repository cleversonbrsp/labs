# Lab 03: Replicar fluxo Navita Connect no Kind
# Build mock-connect -> Docker -> kind load -> kubectl apply
#
# COMO O DEPLOY CHEGA NO SEU KIND:
# O job roda em "self-hosted" = na MÁQUINA onde você registrou o runner do GitHub.
# Essa máquina precisa ser a mesma onde o Kind está rodando e onde o kubectl
# aponta para o cluster (ex.: kind-dev-cluster). Os comandos kubectl apply e
# kind load executam LOCALMENTE nessa máquina, então o deploy vai para o seu
# cluster. Se rodar em ubuntu-latest (GitHub), não teria acesso ao seu Kind.

name: Connect Kind (build + deploy)

on:
  push:
    branches: [main]
    paths:
      - '03 - nvt-cnt/**'
      - '.github/workflows/pipeline-connect-kind.yml'
  workflow_dispatch:

env:
  NAMESPACE: nvt-cnt
  IMAGE_NAME: connect:local
  # Nome do cluster Kind (kubectl config current-context = kind-<KIND_CLUSTER_NAME>)
  KIND_CLUSTER_NAME: dev-cluster

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Build mock-connect
        run: |
          cd "03 - nvt-cnt/mock-connect"
          mvn -q package -DskipTests
          echo "VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)" >> $GITHUB_ENV

      - name: Docker build
        run: |
          cd "03 - nvt-cnt/mock-connect"
          docker build -t ${{ env.IMAGE_NAME }} --build-arg VERSION=${{ env.VERSION }} .

      - name: Load image into Kind
        run: kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Create namespace
        run: kubectl apply -f "03 - nvt-cnt/manifests/namespace.yaml"

      - name: Deploy Config Server
        run: |
          kubectl apply -f "03 - nvt-cnt/manifests/config-server/" -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/config-server -n ${{ env.NAMESPACE }} --timeout=120s

      - name: Deploy Connect
        run: |
          kubectl apply -f "03 - nvt-cnt/manifests/connect/" -n ${{ env.NAMESPACE }}
          kubectl rollout status deployment/connect -n ${{ env.NAMESPACE }} --timeout=180s

      - name: Verify
        run: |
          kubectl get pods,svc -n ${{ env.NAMESPACE }}
          kubectl get deployment connect -n ${{ env.NAMESPACE }} -o wide
